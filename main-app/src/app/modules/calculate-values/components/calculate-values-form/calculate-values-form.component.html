<div class="breadcrumbs">
    <a routerLink="/">{{ "port-modelling-fe.common.home" | translate }}</a>
    <span class="calculate-values-form-breadcrumbs__divider">/</span>
    <a routerLink="/calculate">{{ "port-modelling-fe.calculateValues.systemChoice" | translate }}</a>
    <span class="calculate-values-form-breadcrumbs__divider">/</span>
    <span>{{ systemName | translate }}</span>
</div>
<div class="calculate-values-form">
    <h1 class="calculate-values-form-title">
        {{ systemName | translate }}
        <mat-icon class="toggle-icon" (click)="openDialog()">help_outline</mat-icon>
    </h1>
    <mat-stepper orientation="vertical">
        <mat-step [stepControl]="systemParametersForm">
            <ng-template matStepLabel>Заполните параметры системы</ng-template>
            <div class="calculate-values-form-parameters" [formGroup]="systemParametersForm">
                <div class="calculate-values-form-parameters__system-variables">
                    <mat-form-field appearance="outline">
                        <mat-label>{{ "port-modelling-fe.calculateValues.serversNum" | translate }}</mat-label>
                        <input matInput
                               required
                               type="number"
                               min="1"
                               max="10"
                               [formControlName]="parameters.SERVERS_NUM"
                               [matTooltipPosition]="'above'"
                               [matTooltip]="'port-modelling-fe.calculateValues.serversNumHint' | translate"
                        />
                        <mat-hint align="start">{{ "port-modelling-fe.calculateValues.serversNumHint" | translate }}</mat-hint>
                        <mat-error *ngIf="getControl(parameters.SERVERS_NUM).invalid">{{ getErrorMessage(parameters.SERVERS_NUM) | translate }}</mat-error>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>{{ "port-modelling-fe.calculateValues.serveTime" | translate }}</mat-label>
                        <input matInput
                               required
                               type="number"
                               min="0.1"
                               max="5"
                               [formControlName]="parameters.SERVE_TIME"
                               [matTooltipPosition]="'above'"
                               [matTooltip]="'port-modelling-fe.calculateValues.serveTimeHint' | translate"
                        />
                        <mat-hint align="start">{{ "port-modelling-fe.calculateValues.serveTimeHint" | translate }}</mat-hint>
                        <mat-error *ngIf="getControl(parameters.SERVE_TIME).invalid">{{ getErrorMessage(parameters.SERVE_TIME) | translate }}</mat-error>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label [innerHTML]="'port-modelling-fe.calculateValues.lambda' | translate"></mat-label>
                        <input matInput
                               required
                               type="number"
                               min="0.1"
                               max="5"
                               [formControlName]="parameters.LAMBDA"
                               [matTooltipPosition]="'above'"
                               [matTooltip]="'port-modelling-fe.calculateValues.lambdaHint' | translate"
                        />
                        <mat-hint align="start">{{ "port-modelling-fe.calculateValues.lambdaHint" | translate }}</mat-hint>
                        <mat-error *ngIf="getControl(parameters.LAMBDA).invalid">{{ getErrorMessage(parameters.LAMBDA) | translate }}</mat-error>
                    </mat-form-field>
                    <mat-form-field appearance="outline" *ngIf="hasQueue">
                        <mat-label>{{ "port-modelling-fe.calculateValues.queueLength" | translate }}</mat-label>
                        <input matInput
                               required
                               type="number"
                               min="1"
                               max="10"
                               [formControlName]="parameters.QUEUE_LENGTH"
                               [matTooltipPosition]="'above'"
                               [matTooltip]="'port-modelling-fe.calculateValues.queueLengthHint' | translate"
                        />
                        <mat-hint align="start">{{ "port-modelling-fe.calculateValues.queueLengthHint" | translate }}</mat-hint>
                        <mat-error *ngIf="getControl(parameters.QUEUE_LENGTH).invalid">{{ getErrorMessage(parameters.QUEUE_LENGTH) | translate }}</mat-error>
                    </mat-form-field>
                </div>
            </div>
            <button mat-button mat-stroked-button matStepperNext>{{ "port-modelling-fe.common.next" | translate }}</button>
        </mat-step>
        <mat-step [formGroup]="systemParametersForm">
            <ng-template matStepLabel>Выберите график</ng-template>
            <h3>Выберите один или несколько графиков характеристик </h3>
            <table mat-table [dataSource]="availableSystemCharacteristics" class="mat-elevation-z1 calculate-values-form-table">
                <ng-container matColumnDef="yDescription">
                    <th mat-header-cell *matHeaderCellDef class="calculate-values-form-table__description-column"></th>
                    <td mat-cell *matCellDef="let element" class="description-cell" [rowSpan]="7">Y axis</td>
                </ng-container>
                <ng-container matColumnDef="characteristic">
                    <th mat-header-cell *matHeaderCellDef class="calculate-values-form-table__characteristic-column">Characteristic</th>
                    <td mat-cell *matCellDef="let element" class="calculate-values-form-table__characteristic-column"> {{ element.value }} </td>
                </ng-container>
                <ng-container matColumnDef="space">
                    <th mat-header-cell *matHeaderCellDef class="calculate-values-form-table__space-column"></th>
                    <td mat-cell *matCellDef="let element"></td>
                </ng-container>
                <ng-container matColumnDef="lambda">
                    <th mat-header-cell *matHeaderCellDef class="calculate-values-form-table__x-axis-column"> Lambda </th>
                    <td mat-cell *matCellDef="let element">
                        <mat-checkbox [satPopoverAnchor]="popover"
                                      (change)="onParameterSelect($event, parameters.LAMBDA, element)"
                        ></mat-checkbox>
                        {{ element.lambda ? ("from: " + element.lambda.rangeFrom + " to: " + element.lambda.rangeTo) : "" }}
                    </td>
                </ng-container>
                <ng-container matColumnDef="s">
                    <th mat-header-cell *matHeaderCellDef class="calculate-values-form-table__x-axis-column">S</th>
                    <td mat-cell *matCellDef="let element">
                        <mat-checkbox [satPopoverAnchor]="popover"
                                      (change)="onParameterSelect($event, parameters.SERVE_TIME, element)"
                        ></mat-checkbox>
                        {{ element.serveTime ? ("from: " + element.serveTime.rangeFrom + " to: " + element.serveTime.rangeTo) : "" }}
                    </td>
                </ng-container>
                <ng-container matColumnDef="c">
                    <th mat-header-cell *matHeaderCellDef class="calculate-values-form-table__x-axis-column"> C </th>
                    <td mat-cell *matCellDef="let element">
                        <mat-checkbox [satPopoverAnchor]="popover"
                                      (change)="onParameterSelect($event, parameters.SERVERS_NUM, element)"
                        ></mat-checkbox>
                        {{ element.serversNum ? ("from: " + element.serversNum.rangeFrom + " to: " + element.serversNum.rangeTo) : "" }}
                    </td>
                </ng-container>
                <ng-container matColumnDef="k">
                    <th mat-header-cell *matHeaderCellDef class="calculate-values-form-table__x-axis-column"> K </th>
                    <td mat-cell *matCellDef="let element">
                        <mat-checkbox [satPopoverAnchor]="popover"
                                      (change)="onParameterSelect($event, parameters.QUEUE_LENGTH, element)"
                        ></mat-checkbox>
                        {{ element.queueLength ? ("from: " + element.queueLength.rangeFrom + " to: " + element.queueLength.rangeTo) : "" }}                    </td>
                </ng-container>
                <ng-container matColumnDef="filler">
                    <th mat-header-cell *matHeaderCellDef
                        [colSpan]="2"
                        class="calculate-values-form-table__filler-column"></th>
                </ng-container>
                <ng-container matColumnDef="axis-description">
                    <th mat-header-cell *matHeaderCellDef
                        [colSpan]="displayedColumns.length - 2"
                        class="calculate-values-form-table__title-column"> X Axis
                    </th>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['filler', 'axis-description']"></tr>
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
            <div class="calculate-values-form-parameters__submit">
                <button color="primary" mat-raised-button (click)="_onSubmit()">{{"port-modelling-fe.common.calculate" | translate }}</button>
            </div>
        </mat-step>
    </mat-stepper>
</div>
<div class="calculate-values-form__charts-wrapper" *ngIf="charts?.length">
    <app-highchart-wrapper class="mat-elevation-z2" *ngFor="let data of charts; let i = index" [dataModel]="data" [needScroll]="i === 0"></app-highchart-wrapper>
</div>

<sat-popover #popover verticalAlign="below" [hasBackdrop]="true" [interactiveClose]="false" [backdropClass]="'port-modelling-backdrop'">
    <mat-card>
        <mat-card-header>
            <span class="description-span">{{ "port-modelling-fe.calculateValues.xAxisRange" | translate }}</span>
        </mat-card-header>
        <mat-card-content>
            <div class="calculate-values-form-parameters__system-range" [formGroup]="rangeParameterForm">
                <mat-form-field appearance="outline" class="step-field">
                    <mat-label>{{ "port-modelling-fe.calculateValues.from" | translate }}</mat-label>
                    <input matInput
                           required
                           type="number"
                           min="0.1"
                           max="10"
                           [formControlName]="'rangeFrom'"
                           [matTooltipPosition]="'above'"
                           [matTooltip]="'port-modelling-fe.calculateValues.fromFieldHint' | translate"
                    />
                    <mat-hint align="start">{{ "port-modelling-fe.calculateValues.fromFieldHint" | translate }}</mat-hint>
                    <mat-error *ngIf="getControl('rangeFrom').invalid">{{ getErrorMessage("rangeFrom") | translate }}</mat-error>
                </mat-form-field>
                <mat-form-field appearance="outline" class="step-field">
                    <mat-label>{{ "port-modelling-fe.calculateValues.to" | translate }}</mat-label>
                    <input matInput
                           required
                           type="number"
                           min="0.2"
                           max="10"
                           [formControlName]="'rangeTo'"
                           [matTooltipPosition]="'above'"
                           [matTooltip]="'port-modelling-fe.calculateValues.toFieldHint' | translate"
                    />
                    <mat-hint align="start">{{ "port-modelling-fe.calculateValues.toFieldHint" | translate }}</mat-hint>
                    <mat-error *ngIf="getControl('rangeTo').invalid">{{ getErrorMessage("rangeTo") | translate }}</mat-error>
                </mat-form-field>
                <mat-form-field appearance="outline" class="step-field">
                    <mat-label>{{ "port-modelling-fe.calculateValues.step" | translate }}</mat-label>
                    <input
                        matInput
                        required
                        type="number"
                        min="0.1"
                        max="2"
                        [formControlName]="'step'"
                        [matTooltipPosition]="'above'"
                        [matTooltip]="'port-modelling-fe.calculateValues.stepFieldHint' | translate"
                    />
                    <mat-hint align="start">{{ "port-modelling-fe.calculateValues.stepFieldHint" | translate }}</mat-hint>
                    <mat-error *ngIf="getControl('step').invalid">{{ getErrorMessage("step") | translate }}</mat-error>
                </mat-form-field>
            </div>
        </mat-card-content>
        <mat-card-actions>
            <button mat-button mat-stroked-button (click)="onRangeSelect()">Применить</button>
        </mat-card-actions>
    </mat-card>
</sat-popover>
